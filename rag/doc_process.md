# æé«˜RAGå›å¤å‡†ç¡®æ€§å’Œè´¨é‡

---

## ä¸€ã€æ–‡æ¡£é¢„å¤„ç†ä¸åˆ‡åˆ†æµç¨‹ï¼ˆæå‡å¬å›é˜¶æ®µè´¨é‡ï¼‰

RAG çš„ç¬¬ä¸€æ­¥æ˜¯æ£€ç´¢ï¼Œæ£€ç´¢è´¨é‡ç›´æ¥å½±å“æœ€ç»ˆç­”æ¡ˆè´¨é‡ã€‚é’ˆå¯¹è¶…é•¿æ–‡æ¡£ï¼Œåº”é‡‡ç”¨ç³»ç»Ÿçš„é¢„å¤„ç†å’Œåˆ‡åˆ†ç­–ç•¥ï¼š

### âœ… 1. æ–‡æ¡£æ¸…æ´—ï¼ˆæ¸…ç†æ— ç”¨ä¿¡æ¯ï¼‰

* åˆ é™¤é¡µçœ‰é¡µè„šã€ç›®å½•ç´¢å¼•ã€ç‰ˆæƒä¿¡æ¯ç­‰å†—ä½™å†…å®¹ã€‚
* æ ‡å‡†åŒ–æ ¼å¼ï¼ˆæ¯”å¦‚ç»Ÿä¸€æ ‡é¢˜æ ¼å¼ã€æ¸…é™¤ä¹±ç ç­‰ï¼‰ã€‚

### âœ… 2. æ–‡æ¡£ç»“æ„è§£æï¼ˆæ„å»ºè¯­ä¹‰å±‚æ¬¡ï¼‰

* ä½¿ç”¨è§„åˆ™æˆ–æ¨¡å‹æå–ç»“æ„åŒ–ä¿¡æ¯ï¼Œå¦‚ï¼š

  * ä¸€çº§æ ‡é¢˜ã€äºŒçº§æ ‡é¢˜ï¼ˆH1ã€H2...ï¼‰
  * è¡¨æ ¼ã€åˆ—è¡¨ã€æ®µè½ã€å¼•ç”¨ç­‰
* å½¢æˆæ ‘çŠ¶ç»“æ„ï¼ˆæ–‡æ¡£ç« èŠ‚æ ‘ï¼‰ï¼Œç”¨äºåç»­åˆ‡åˆ†ä¸­çš„â€œè¯­ä¹‰å½’å±â€ã€‚

### âœ… 3. æ™ºèƒ½åˆ‡åˆ†ç­–ç•¥ï¼ˆChunkingï¼‰

ä¸ºäº†æ—¢ä¿è¯ chunk ä¸è¿‡é•¿ï¼Œåˆä¿ç•™è¯­ä¹‰å®Œæ•´æ€§ï¼š

| åˆ‡åˆ†æ–¹å¼           | è¯´æ˜                                                         |
| -------------- | ---------------------------------------------------------- |
| åŸºäºæ ‡é¢˜åˆ‡åˆ†         | æŒ‰ç« èŠ‚æ ‡é¢˜æˆ–å°èŠ‚æ–­ç‚¹åˆ‡åˆ†ï¼Œä¿è¯ä¸Šä¸‹æ–‡å®Œæ•´ï¼ˆé€‚ç”¨äºç»“æ„åŒ–æ–‡æ¡£ï¼‰                             |
| Sliding Window | æ»‘åŠ¨çª—å£ç­–ç•¥ï¼ŒåŠ å…¥é‡å åŒºåŸŸï¼ˆå¦‚æ¯æ®µ overlap 20-30%ï¼Œé˜²æ­¢ä¿¡æ¯æ–­è£‚ï¼‰                   |
| åŸºäºè¯­ä¹‰å¥å…ƒåˆ‡åˆ†       | ä½¿ç”¨ NLP å·¥å…·ï¼ˆå¦‚ SpaCyã€NLTKï¼‰æŒ‰å¥ã€æ®µè½ã€è¯­ä¹‰æ–­ç‚¹åˆ‡åˆ†                        |
| Token é™åˆ¶åˆ‡åˆ†     | æ§åˆ¶æ¯æ®µ chunk çš„ token æ•°é‡ï¼ˆå¦‚ 500\~800 tokenï¼‰ï¼Œä¿è¯é€‚é…å‘é‡æ¨¡å‹å’Œ LLM è¾“å…¥é™åˆ¶ |

> âš ï¸å»ºè®®ä½¿ç”¨**é€’å½’æ–‡æœ¬åˆ‡åˆ†å™¨ Recursive Text Splitterï¼ˆLangChain æä¾›ï¼‰**ï¼šä»æ®µè½ â†’ å¥å­ â†’ è¯å±‚çº§è¿›è¡Œæ™ºèƒ½åˆ‡åˆ†ï¼Œä¿è¯è¯­ä¹‰å°½å¯èƒ½å®Œæ•´ã€‚

### âœ… 4. å…ƒæ•°æ®å¢å¼ºï¼ˆMetadata Taggingï¼‰

æ¯ä¸ª chunk é™„å¸¦ä»¥ä¸‹å…ƒä¿¡æ¯ï¼Œç”¨äºåç»­è¿‡æ»¤ä¸ rerankï¼š

* æ‰€å±ç« èŠ‚è·¯å¾„ï¼ˆå¦‚â€œç¬¬3ç«  > å°èŠ‚2 > æ®µè½4â€ï¼‰
* æ–‡æ¡£åç§°ã€é¡µç ã€æ—¥æœŸç­‰
* å¯é€‰å…³é”®è¯ã€ä¸»é¢˜æ ‡ç­¾ã€æ–‡æ¡£æ¥æºç­‰

---

## äºŒã€å‘é‡ç´¢å¼•æ„å»ºä¸æ£€ç´¢ä¼˜åŒ–ï¼ˆæå‡åŒ¹é…é˜¶æ®µè´¨é‡ï¼‰

### âœ… 1. å‘é‡æ¨¡å‹é€‰æ‹©

* å»ºè®®ä½¿ç”¨å¼€æºè¯­ä¹‰å‘é‡æ¨¡å‹å¦‚ï¼š

  * `bge-large-en` / `bge-m3`ï¼ˆä¸­æ–‡ç”¨ `bge-large-zh`ï¼‰
  * `E5` ç³»åˆ—ï¼š`intfloat/e5-large`
  * `GTE-base`ï¼ˆè½»é‡åŒ–é«˜æ€§èƒ½ï¼‰

### âœ… 2. Embedding æ„å»º

* å¯¹ä¸Šè¿°åˆ‡åˆ†åçš„ chunk åš embedding å‘é‡åŒ–ã€‚
* å¯ç”¨ `FAISS` / `Milvus` / `Weaviate` ç­‰æ„å»ºå‘é‡æ•°æ®åº“ã€‚

### âœ… 3. å‘é‡æ£€ç´¢ä¼˜åŒ–

* ä½¿ç”¨ hybrid searchï¼ˆå‘é‡ + BM25ï¼‰ã€å¤šè·¯å¬å›ï¼ˆembedding + keywordï¼‰ã€æ·»åŠ  rerankï¼ˆcross encoder æ¨¡å‹ï¼‰ã€‚
* é’ˆå¯¹æŸ¥è¯¢é—®é¢˜ï¼š

  * Query Expansionï¼šå¯¹ç”¨æˆ· query åš paraphrasing æˆ–åŠ  keywordã€‚
  * Query-Document Alignmentï¼šé€šè¿‡ reranker æ¨¡å‹è®¡ç®— query ä¸æ–‡æ¡£å—ä¹‹é—´çš„è·¨è¯­ä¹‰åŒ¹é…ã€‚

---

## ä¸‰ã€ç”Ÿæˆé˜¶æ®µä¼˜åŒ–ï¼ˆæå‡å›ç­”å‡†ç¡®æ€§ï¼‰

### âœ… 1. Prompt æ„é€ æŠ€å·§

* åŠ å…¥æç¤ºè¯è®© LLM èšç„¦äºç»™å®š contextï¼Œä¸â€œç¼–é€ â€ï¼š

```text
è¯·ä»…æ ¹æ®æä¾›çš„èµ„æ–™å›ç­”ï¼Œä¸è¦æ·»åŠ å¤–éƒ¨ä¿¡æ¯ã€‚è‹¥æ— æ³•ç¡®å®šï¼Œè¯·å›ç­”â€œæ— æ³•ç¡®å®šâ€ã€‚
èµ„æ–™å¦‚ä¸‹ï¼š
{retrieved_chunks}
é—®é¢˜ï¼š{user_question}
```

### âœ… 2. å¤šæ®µä¿¡æ¯èåˆ

* è‹¥æ£€ç´¢å‡ºå¤šä¸ªç›¸å…³ chunkï¼Œå¯ï¼š

  * åˆå¹¶æ‘˜è¦åè¾“å…¥ LLM
  * ç”¨ `Map-Reduce` æˆ– `Refine` ç­–ç•¥ç”Ÿæˆç­”æ¡ˆ

### âœ… 3. å¼•ç”¨é“¾ä¸æ¥æºå¯è¿½æº¯æ€§

* ä¿ç•™å›ç­”ä¸­ä½¿ç”¨çš„ chunk æ¥æºè·¯å¾„ï¼Œä¾›ç”¨æˆ·éªŒè¯ã€‚

---

## å››ã€å¯é€‰æå‡ç‚¹

* **ä½¿ç”¨ LLM æˆ–è§„åˆ™ç”Ÿæˆâ€œæ‘˜è¦â€embedding**ï¼Œæ›¿ä»£å…¨æ–‡ embeddingï¼Œæé«˜è¯­ä¹‰è¦†ç›–åº¦ã€‚
* **æ„å»ºå¤šç²’åº¦ç´¢å¼•**ï¼šæ®µè½çº§ + å°èŠ‚çº§ï¼Œå±‚çº§æ£€ç´¢ã€‚
* **ä½¿ç”¨ç»“æ„åŒ–é—®ç­”æ¨¡å—ï¼ˆå¦‚ LangChain QAChainï¼‰**ï¼Œæ”¯æŒâ€œé—®ç­”è®°å¿†â€å’Œä¸Šä¸‹æ–‡çª—å£ç®¡ç†ã€‚
* **è¯„ä¼°æ¨¡å—åµŒå…¥**ï¼šæ­é…è¯„ä¼°å™¨è‡ªåŠ¨åˆ¤æ–­ç­”æ¡ˆæ˜¯å¦å‘½ä¸­çŸ¥è¯†ã€æ˜¯å¦ hallucinationã€‚

---
# Query Expansionï¼ˆæŸ¥è¯¢æ‰©å±•ï¼‰
æ˜¯æå‡æ£€ç´¢å¬å›ç‡ä¸è¯­ä¹‰åŒ¹é…åº¦çš„æœ‰æ•ˆæ‰‹æ®µã€‚å®ƒçš„ç›®æ ‡æ˜¯æŠŠç”¨æˆ·åŸå§‹æŸ¥è¯¢è¿›è¡Œ**é‡å†™ï¼ˆparaphrasingï¼‰æˆ–æ‹“å±•ï¼ˆæ·»åŠ å…³é”®è¯ï¼‰**ï¼Œä½¿å…¶èƒ½æ›´å¥½åœ°åŒ¹é…åˆ°æ–‡æ¡£ä¸­çš„è¡¨è¿°æ–¹å¼ã€‚

---

## ğŸ” ä¸ºä»€ä¹ˆéœ€è¦ Query Expansionï¼Ÿ

ç”¨æˆ·çš„é—®é¢˜å¾€å¾€**è¡¨è¾¾æ–¹å¼ä¸ä¸€è‡´**ï¼Œè€Œæ–‡æ¡£ä¸­å¯èƒ½ä½¿ç”¨ä¸åŒçš„è¯´æ³•ã€‚ä¾‹å¦‚ï¼š

* ç”¨æˆ·é—®ï¼š**â€œè¿™æ¬¾äº§å“çš„ä¼˜ç‚¹æœ‰å“ªäº›ï¼Ÿâ€**
* æ–‡æ¡£è¯´ï¼š**â€œè¯¥è®¾å¤‡çš„ä¼˜åŠ¿åŒ…æ‹¬â€¦â€**ã€â€œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹â€¦â€

é€šè¿‡å¯¹åŸå§‹æŸ¥è¯¢è¿›è¡Œè¯­ä¹‰æ”¹å†™æˆ–å…³é”®è¯æ‹“å±•ï¼Œå¯ä»¥æå‡æ£€ç´¢ç³»ç»Ÿçš„**å¬å›èƒ½åŠ›**ä¸**å‘é‡åŒ¹é…åº¦**ã€‚

---

## ğŸ§  Query Expansion çš„ä¸¤ç±»æ–¹å¼

### âœ… æ–¹å¼ä¸€ï¼šParaphrasingï¼ˆæŸ¥è¯¢é‡å†™ï¼‰

> å°†åŸå§‹é—®é¢˜ç”Ÿæˆå¤šä¸ªè¯­ä¹‰ç›¸ä¼¼ä½†è¡¨è¾¾æ–¹å¼ä¸åŒçš„å˜ä½“ã€‚

#### æ–¹æ³•ï¼š

* ä½¿ç”¨ LLM è¿›è¡Œ query æ”¹å†™ï¼Œå¦‚ï¼š

```text
è¯·æ”¹å†™ä¸‹åˆ—é—®é¢˜ï¼Œä½¿å…¶è¡¨è¾¾ä¸åŒä½†å«ä¹‰ä¸€è‡´ï¼š
åŸå§‹é—®é¢˜ï¼š{user_query}
è¾“å‡º3ç§ä¸åŒè¡¨è¾¾æ–¹å¼ã€‚
```

* ç¤ºä¾‹ï¼š

  ```
  åŸå§‹ï¼šå­¦ç”Ÿåœ¨æ ¡æœŸé—´å¯ä»¥ç”³è¯·å“ªäº›å¥–å­¦é‡‘ï¼Ÿ
  æ‰©å±•ï¼š
  1. åœ¨è¯»å­¦ç”Ÿæœ‰å“ªäº›å¥–åŠ©é‡‘å¯ä»¥ç”³æŠ¥ï¼Ÿ
  2. å­¦æ ¡æä¾›å“ªäº›å¥–å­¦é‡‘ä¾›å­¦ç”Ÿç”³è¯·ï¼Ÿ
  3. æœ¬ç§‘ç”Ÿå¯è·å¾—å“ªäº›èµ„åŠ©é¡¹ç›®ï¼Ÿ
  ```

#### åº”ç”¨æ–¹å¼ï¼š

* å°†æ”¹å†™åçš„ query ä¸€èµ·å»åšå‘é‡ embedding â†’ æ‰©å±•æ£€ç´¢å¬å›èŒƒå›´ã€‚
* æˆ–ç”¨å®ƒä»¬å•ç‹¬å»æŸ¥è¯¢å…³é”®è¯ç´¢å¼•ã€BM25ç­‰ã€‚

---

### âœ… æ–¹å¼äºŒï¼šKeyword Injectionï¼ˆå…³é”®è¯æ³¨å…¥ï¼‰

> ä¸ºåŸå§‹ query æ·»åŠ å¯èƒ½å‡ºç°äºæ–‡æ¡£ä¸­çš„â€œå…³é”®è¯â€æˆ–â€œåŒä¹‰è¯â€ä»¥å¢å¼ºå¬å›ã€‚

#### æ–¹æ³•ä¸€ï¼šåˆ©ç”¨é¢†åŸŸè¯åº“ï¼ˆæ¨èï¼‰

* é’ˆå¯¹ç‰¹å®šé¢†åŸŸï¼ˆå¦‚åŒ»å­¦ã€æ•™è‚²ã€é‡‘èï¼‰ï¼Œç»´æŠ¤ä¸€ä¸ª**å…³é”®è¯åŒä¹‰è¯è¯å…¸**ï¼Œè¿›è¡Œ query æ‹“å±•ã€‚
* ç¤ºä¾‹ï¼š

  * è¾“å…¥ï¼šâ€œç–¾ç—…çš„ä¼ æ’­æ–¹å¼æœ‰å“ªäº›ï¼Ÿâ€
  * æ‰©å±•å…³é”®è¯ï¼š**â€œä¼ æ’­é€”å¾„â€**, â€œæ„ŸæŸ“è·¯å¾„â€, â€œä¼ æŸ“æ–¹å¼â€ç­‰

#### æ–¹æ³•äºŒï¼šä½¿ç”¨ LLM æŠ½å–å…³é”®è¯å¹¶æ‹“å±•

```text
è¯·æå–ä¸‹åˆ—é—®é¢˜ä¸­çš„æ ¸å¿ƒå…³é”®è¯ï¼Œå¹¶æä¾›3ä¸ªå¯èƒ½çš„åŒä¹‰æˆ–ç›¸å…³è¯ï¼š
é—®é¢˜ï¼š{user_query}
è¾“å‡ºæ ¼å¼ï¼šå…³é”®è¯ - åŒä¹‰è¯1, åŒä¹‰è¯2, åŒä¹‰è¯3
```

#### æ–¹æ³•ä¸‰ï¼šEmbedding-based Keyword Matching

* å¯¹ query åš embeddingï¼Œä¸ä¸€ä¸ªåŒ…å«å…³é”®è¯çš„å‘é‡è¯å…¸è¿›è¡Œç›¸ä¼¼åº¦è®¡ç®—ï¼Œæ‰¾åˆ° semantically close çš„ keywordã€‚

---

## ğŸ› ï¸ é›†æˆ Query Expansion åˆ° RAG æµç¨‹

```mermaid
graph LR
Q[åŸå§‹ç”¨æˆ·Query] -->|LLMæ”¹å†™/å…³é”®è¯æ³¨å…¥| QE[æ‰©å±•åçš„Queryé›†]
QE -->|Embedding| VecQ[Queryå‘é‡]
VecQ -->|ç›¸ä¼¼åº¦è®¡ç®—| R[æ–‡æ¡£å—å¬å›]
R -->|ä¸Šä¸‹æ–‡æ‹¼æ¥| G[LLMç”Ÿæˆç­”æ¡ˆ]
```

### ç¤ºä¾‹ä»£ç æ¡†æ¶ï¼ˆä¼ªä»£ç ï¼‰ï¼š

```python
def expand_query_with_llm(query):
    prompt = f"è¯·æ”¹å†™ä¸‹åˆ—é—®é¢˜ï¼Œä½¿è¡¨è¾¾ä¸åŒä½†å«ä¹‰ä¸€è‡´ï¼š{query}"
    paraphrases = call_openai(prompt)
    return [query] + paraphrases

def expand_query_with_keywords(query):
    keywords = extract_keywords_with_llm_or_dict(query)
    expanded_queries = [f"{query} {kw}" for kw in keywords]
    return [query] + expanded_queries

def get_expanded_embeddings(queries, embed_model):
    return [embed_model.encode(q) for q in queries]

def retrieve_chunks(expanded_embeddings, vector_store):
    return vector_store.search(expanded_embeddings, top_k=3)

# æ•´åˆåˆ° RAG
expanded_queries = expand_query_with_llm(user_query)
query_embeddings = get_expanded_embeddings(expanded_queries, embed_model)
retrieved_chunks = retrieve_chunks(query_embeddings, faiss_index)
```

---

## ğŸ§ª å®è·µå»ºè®®

| åœºæ™¯            | æ¨èæ–¹å¼                                   |
| ------------- | -------------------------------------- |
| é€šç”¨é—®ç­”          | LLM æ”¹å†™ + åŸºæœ¬å…³é”®è¯æå–                       |
| æ•™è‚²ã€é‡‘èã€æ³•å¾‹ç­‰å‚ç›´é¢†åŸŸ | ä½¿ç”¨é¢†åŸŸè¯å…¸ + BM25 keywords                 |
| æ€§èƒ½æ•æ„Ÿï¼ˆéœ€å¿«ï¼‰      | ä»…æ‰©å±• 1\~2 ä¸ª paraphrase + fast embedding |
| å‡†ç¡®æ€§è¦æ±‚é«˜        | rerank æ‰©å±•åå¬å›ç»“æœï¼Œé¿å…è¿‡å¤šå™ªå£°                  |

---

# åŸºäºå¯¹è¯å†å²ä¸Šä¸‹æ–‡çš„ Query Expansion
æ˜¯åœ¨**å¤šè½®å¯¹è¯**æˆ–äº¤äº’å¼é—®ç­”åœºæ™¯ä¸­æä¸ºé‡è¦çš„ä¸€ç§ç­–ç•¥ï¼Œå°¤å…¶é€‚ç”¨äºä»¥ä¸‹å‡ ç±»æƒ…å†µï¼š

* ç”¨æˆ·æé—®ç®€ç•¥ç”šè‡³çœç•¥ä¸»è¯­ï¼ˆå¦‚â€œå®ƒä»€ä¹ˆæ—¶å€™å¼€å§‹ï¼Ÿâ€ï¼‰
* ç”¨æˆ·åœ¨è¿ç»­æé—®åŒä¸€ä¸»é¢˜ï¼ˆå¦‚â€œä¸Šä¸€ä¸ªé¡¹ç›®çš„é¢„ç®—æ˜¯å¤šå°‘ï¼Ÿé‚£å®ƒä»€ä¹ˆæ—¶å€™å¯åŠ¨ï¼Ÿâ€ï¼‰
* ç”¨æˆ·çš„ query å­˜åœ¨ä¸Šä¸‹æ–‡ä¾èµ–ï¼ˆå¦‚â€œå†å¸®æˆ‘æŸ¥ä¸€ä¸‹å®ƒçš„åŠŸèƒ½â€ï¼‰

---

## ğŸ“Œ ä¸€ã€ä»€ä¹ˆæ˜¯åŸºäºä¸Šä¸‹æ–‡çš„ Query Expansionï¼Ÿ

å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š**å°†å½“å‰ç”¨æˆ·æé—®ç»“åˆå†å²å¯¹è¯ä¸Šä¸‹æ–‡è¿›è¡Œè¡¥å…¨æˆ–é‡å†™**ï¼Œä»¥ç”Ÿæˆä¸€ä¸ªâ€œä¸Šä¸‹æ–‡è‡ªæ´½â€çš„å®Œæ•´ queryï¼Œä½¿å¾—æ£€ç´¢ä¸ç”Ÿæˆæ›´å‡†ç¡®ã€‚

---

## ğŸ§  å…³é”®å®ç°æ€è·¯

### âœ… 1. å†å²å¯¹è¯çŠ¶æ€å»ºæ¨¡

å¯¹å†å²æ¶ˆæ¯è¿›è¡Œå»ºæ¨¡ï¼Œæå–å¿…è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š

* æœ€è¿‘ä¸€æ¬¡æåŠçš„ä¸»é¢˜/å®ä½“ï¼ˆâ€œè¿™ä¸ªé¡¹ç›®â€æŒ‡ä»£å“ªä¸ªï¼Ÿï¼‰
* å†å²é—®é¢˜å’Œå›ç­”çš„å†…å®¹æ‘˜è¦
* ç”¨æˆ·å½“å‰é—®é¢˜ä¸­çš„çœç•¥è¯­ä¹‰

### âœ… 2. ä¸Šä¸‹æ–‡è¡¥å…¨ / æ”¹å†™ï¼ˆContextual Rewritingï¼‰

#### æ–¹æ³•ä¸€ï¼šä½¿ç”¨ LLM è¿›è¡Œä¸Šä¸‹æ–‡é‡å†™

```text
ä½ æ˜¯ä¸€ä¸ªé—®ç­”åŠ©æ‰‹ï¼Œè¯·æ ¹æ®å†å²å¯¹è¯å’Œç”¨æˆ·å½“å‰é—®é¢˜ï¼Œç”Ÿæˆä¸€ä¸ªå®Œæ•´æ¸…æ™°çš„æŸ¥è¯¢é—®é¢˜ã€‚

å†å²å¯¹è¯ï¼š
Q1: è¯·ä»‹ç»ä¸€ä¸‹Taurusé¡¹ç›®ã€‚
A1: Taurusé¡¹ç›®æ˜¯ä¸€ä¸ªç”¨äºè‡ªåŠ¨åŒ–æµ‹è¯•çš„æ•°æ®å¹³å°...
Q2: å®ƒä»€ä¹ˆæ—¶å€™ä¸Šçº¿ï¼Ÿ

â†’ è¾“å‡ºï¼šTaurusé¡¹ç›®æ˜¯ä»€ä¹ˆæ—¶å€™ä¸Šçº¿çš„ï¼Ÿ
```

#### æ–¹æ³•äºŒï¼šæ£€ç´¢+è§„åˆ™è¡¥å…¨

* åˆ©ç”¨ last topic/entity tracking + query templateï¼Œå¿«é€Ÿæ‹¼æ¥æˆå®Œæ•´æŸ¥è¯¢å¥
* å¸¸è§ç­–ç•¥ï¼š

  * æŠ½å–ä¸Šä¸€æ¬¡å®ä½“ï¼šå¦‚â€œå®ƒâ€ â†’ æœ€è¿‘ä¸€æ¬¡æåˆ°çš„â€œxxxé¡¹ç›®â€
  * è·Ÿè¸ªä¸»é¢˜ threadï¼šå¦‚â€œå†å¸®æˆ‘çœ‹ä¸€ä¸‹é‚£ä¸ªAPIâ€ï¼Œå¯æ¨æ–­ä¸ºä¸Šè½®æåˆ°çš„æ¥å£

---

## ğŸ§° å®ç°æ¨¡å—å»ºè®®ï¼ˆç»„ä»¶åŒ–ï¼‰

### æ¨¡å— 1ï¼šå†å²ä¸Šä¸‹æ–‡æ‘˜è¦å™¨ï¼ˆå¯é€‰ï¼‰

```python
def summarize_history(dialogue_turns):
    return LLM("è¯·æ€»ç»“ä»¥ä¸‹å¯¹è¯ä¸­çš„ä¸»é¢˜å®ä½“ï¼š", dialogue_turns)
```

### æ¨¡å— 2ï¼šä¸Šä¸‹æ–‡å¢å¼º Query Rewriter

```python
def rewrite_query_with_context(history, current_query):
    prompt = f"""
    æ ¹æ®ä»¥ä¸‹å¯¹è¯å†å²å’Œå½“å‰é—®é¢˜ï¼Œæ”¹å†™ä¸ºä¸€ä¸ªæ¸…æ™°ã€å®Œæ•´ã€ä¸Šä¸‹æ–‡æ— æ­§ä¹‰çš„é—®é¢˜ï¼š

    å¯¹è¯å†å²ï¼š
    {history}

    å½“å‰é—®é¢˜ï¼š
    {current_query}

    æ”¹å†™åçš„é—®é¢˜ï¼š
    """
    return call_openai(prompt)
```

### æ¨¡å— 3ï¼šé›†æˆåˆ° RAG æŸ¥è¯¢æµç¨‹

```python
# Step 1: ä¸Šä¸‹æ–‡æ”¹å†™
full_query = rewrite_query_with_context(dialogue_history, user_query)

# Step 2: query expansionï¼ˆparaphrase + keywordï¼‰
expanded_queries = expand_query_with_llm(full_query)

# Step 3: å‘é‡æ£€ç´¢ + RAG
```

---

## ğŸ§ª åº”ç”¨æ•ˆæœä¸¾ä¾‹

### åŸå§‹å¯¹è¯ï¼š

```
Q: è¯·ä»‹ç»ä¸€ä¸‹Neoç³»ç»Ÿã€‚
A: Neoç³»ç»Ÿæ˜¯ä¸ºå†…éƒ¨å‘˜å·¥è®¾è®¡çš„åä½œå¹³å°ã€‚

Q: å®ƒæ”¯æŒå“ªäº›åŠŸèƒ½ï¼Ÿ
```

### é‡å†™å queryï¼š

```
Neoç³»ç»Ÿæ”¯æŒå“ªäº›åŠŸèƒ½ï¼Ÿ
```

è¿™æ ·æ‰èƒ½åœ¨å‘é‡æ£€ç´¢ä¸­æ‰¾åˆ°åŒ…å«â€œNeoç³»ç»ŸåŠŸèƒ½ä»‹ç»â€çš„æ®µè½ï¼Œè€Œä¸ä¼šé”™å¬â€œå®ƒâ€æŒ‡å‘å…¶ä»–å†…å®¹ã€‚

---

## âœ… æ€»ç»“ï¼šQuery Expansion çš„ä¸‰å±‚åˆæˆç­–ç•¥

| å±‚çº§    | å†…å®¹ç±»å‹                       | æ˜¯å¦ä¾èµ–ä¸Šä¸‹æ–‡ |
| ----- | -------------------------- | ------- |
| è¯­ä¹‰æ”¹å†™  | Paraphrasing               | å¦       |
| å…³é”®è¯æ‰©å±• | Synonym / Related Terms    | å¦       |
| ä¸Šä¸‹æ–‡è¡¥å…¨ | Contextual Query Rewriting | âœ… æ˜¯     |

---
